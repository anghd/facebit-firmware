#include "HRFilter.h"

static float filter_taps[HRFILTER_TAP_NUM] = {
  0.004343648429859878,
  -0.00029849004445356024,
  -0.00040805281664249164,
  -0.0005586932050161339,
  -0.0007020182389071765,
  -0.0007787940439654815,
  -0.0007251341721819502,
  -0.000479390534667564,
  0.00000824109591166227,
  0.0007699561932299281,
  0.0018120269472024129,
  0.0031098430163142943,
  0.004605725633119509,
  0.006209314024840038,
  0.007802041161090666,
  0.009244655521383472,
  0.010387832524979315,
  0.011086947785440598,
  0.011213402443137312,
  0.010671612841113719,
  0.009410775499552326,
  0.007435257013742991,
  0.004813324080942856,
  0.0016481617759183424,
  -0.0018560370858528932,
  -0.0054903544378795315,
  -0.009006518101586059,
  -0.012151328308797534,
  -0.01468817316134298,
  -0.016420056137445106,
  -0.01721193774087845,
  -0.01700665261689631,
  -0.01583705726065614,
  -0.013829298913352158,
  -0.011197053396396544,
  -0.008227878116127692,
  -0.00526084295340634,
  -0.0026579966667890165,
  -0.0007717612542997101,
  0.00009152373950336154,
  -0.00029987170029245727,
  -0.0020703260535267077,
  -0.005218395647803842,
  -0.009605618979252092,
  -0.014957214709019322,
  -0.020879754726572403,
  -0.026871618243479885,
  -0.032378303880728154,
  -0.03682113468388151,
  -0.039649456988716074,
  -0.04038790919927541,
  -0.0386807714639397,
  -0.03432940789346844,
  -0.027317230320223426,
  -0.017822752875326142,
  -0.006216643843986045,
  0.006957263476767651,
  0.02101414633324736,
  0.035173500133202557,
  0.0486128745307645,
  0.06052587609863714,
  0.07018350032940462,
  0.07698093291812327,
  0.08049095325698213,
  0.08049095325698213,
  0.07698093291812327,
  0.07018350032940462,
  0.06052587609863714,
  0.0486128745307645,
  0.035173500133202557,
  0.02101414633324736,
  0.006957263476767651,
  -0.006216643843986045,
  -0.017822752875326142,
  -0.027317230320223426,
  -0.03432940789346844,
  -0.0386807714639397,
  -0.04038790919927541,
  -0.039649456988716074,
  -0.03682113468388151,
  -0.032378303880728154,
  -0.026871618243479885,
  -0.020879754726572403,
  -0.014957214709019322,
  -0.009605618979252092,
  -0.005218395647803842,
  -0.0020703260535267077,
  -0.00029987170029245727,
  0.00009152373950336154,
  -0.0007717612542997101,
  -0.0026579966667890165,
  -0.00526084295340634,
  -0.008227878116127692,
  -0.011197053396396544,
  -0.013829298913352158,
  -0.01583705726065614,
  -0.01700665261689631,
  -0.01721193774087845,
  -0.016420056137445106,
  -0.01468817316134298,
  -0.012151328308797534,
  -0.009006518101586059,
  -0.0054903544378795315,
  -0.0018560370858528932,
  0.0016481617759183424,
  0.004813324080942856,
  0.007435257013742991,
  0.009410775499552326,
  0.010671612841113719,
  0.011213402443137312,
  0.011086947785440598,
  0.010387832524979315,
  0.009244655521383472,
  0.007802041161090666,
  0.006209314024840038,
  0.004605725633119509,
  0.0031098430163142943,
  0.0018120269472024129,
  0.0007699561932299281,
  0.00000824109591166227,
  -0.000479390534667564,
  -0.0007251341721819502,
  -0.0007787940439654815,
  -0.0007020182389071765,
  -0.0005586932050161339,
  -0.00040805281664249164,
  -0.00029849004445356024,
  0.004343648429859878
};

void HRFilter_init(HRFilter* f) {
  int i;
  for(i = 0; i < HRFILTER_TAP_NUM; ++i)
    f->history[i] = 0;
  f->last_index = 0;
}

void HRFilter_put(HRFilter* f, float input) {
  f->history[(f->last_index++) & 127] = input;
}

float HRFilter_get(HRFilter* f) {
  float acc = 0;
  int index = f->last_index, i;
  for(i = 0; i < HRFILTER_TAP_NUM; ++i) {
    acc += f->history[(index--) & 127] * filter_taps[i];
  };
  return acc;
}
