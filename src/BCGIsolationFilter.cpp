#include "BCGIsolationFilter.h"

static float filter_taps[BCGISOLATIONFILTER_TAP_NUM] = {
  -0.002901337386487072,
  0.0011506720453230048,
  0.008950552886088512,
  0.005725454910716104,
  -0.013986516003506979,
  -0.009864500797374477,
  0.012655021399506356,
  0.02134901930915826,
  -0.00880673682970461,
  -0.028494622809533108,
  -0.0010894470072574862,
  0.030382544393529155,
  0.011034720869606838,
  -0.022917851652488098,
  -0.01731964084826694,
  0.011978552448878467,
  0.010937548007400112,
  -0.0007712168027276769,
  0.004924830202277783,
  0.0018113322601083608,
  -0.02786902862701894,
  -0.01791229262506755,
  0.04421899600952795,
  0.05058406671904897,
  -0.04516125614277318,
  -0.08819319306872822,
  0.022425425357981598,
  0.11854520089865048,
  0.0190544759231388,
  -0.12703004699483694,
  -0.06847049570968695,
  0.1088911713016057,
  0.1088911713016057,
  -0.06847049570968695,
  -0.12703004699483694,
  0.0190544759231388,
  0.11854520089865048,
  0.022425425357981598,
  -0.08819319306872822,
  -0.04516125614277318,
  0.05058406671904897,
  0.04421899600952795,
  -0.01791229262506755,
  -0.02786902862701894,
  0.0018113322601083608,
  0.004924830202277783,
  -0.0007712168027276769,
  0.010937548007400112,
  0.011978552448878467,
  -0.01731964084826694,
  -0.022917851652488098,
  0.011034720869606838,
  0.030382544393529155,
  -0.0010894470072574862,
  -0.028494622809533108,
  -0.00880673682970461,
  0.02134901930915826,
  0.012655021399506356,
  -0.009864500797374477,
  -0.013986516003506979,
  0.005725454910716104,
  0.008950552886088512,
  0.0011506720453230048,
  -0.002901337386487072
};

void BCGIsolationFilter_init(BCGIsolationFilter* f) {
  int i;
  for(i = 0; i < BCGISOLATIONFILTER_TAP_NUM; ++i)
    f->history[i] = 0;
  f->last_index = 0;
}

void BCGIsolationFilter_put(BCGIsolationFilter* f, float input) {
  f->history[(f->last_index++) & 63] = input;
}

float BCGIsolationFilter_get(BCGIsolationFilter* f) {
  float acc = 0;
  int index = f->last_index, i;
  for(i = 0; i < BCGISOLATIONFILTER_TAP_NUM; ++i) {
    acc += f->history[(index--) & 63] * filter_taps[i];
  };
  return acc;
}
